<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secret Santa (Secure)</title>

<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: auto;
        padding: 20px;
        background: #fafafa;
    }
    input, textarea, button {
        padding: 10px;
        margin: 5px 0;
        width: 100%;
        font-size: 16px;
    }
    textarea {
        height: 120px;
    }
    button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }
    button:hover {
        background: #0056b3;
    }
    .hidden {
        display: none;
    }
</style>

</head>
<body>

<h1>Secret Santa ðŸŽ…</h1>

<!-- Setup section -->
<div id="setup">
    <h2>Step 1: Enter Names</h2>
    <textarea id="names" placeholder="Enter names, one per line..."></textarea>
    <button onclick="generateLinks()">Generate Secret Santa</button>
    <div id="links"></div>
</div>

<!-- Reveal section -->
<div id="reveal" class="hidden">
    <h2>Your Secret Santa Assignment</h2>
    <p id="assignment" style="font-size: 24px; font-weight: bold;"></p>
</div>


<script>
// === CONFIG: path to your GitHub JSON ===
const repoPath = "https://buzkonyuszko.github.io/secret-santa/assignments.json";


// === AES Encryption ===
function encrypt(text, password) {
    return CryptoJS.AES.encrypt(text, password).toString();
}
function decrypt(ciphertext, password) {
    try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, password);
        return bytes.toString(CryptoJS.enc.Utf8) || null;
    } catch {
        return null;
    }
}


// === Shuffle Function ===
function shuffle(arr) {
    let a = [...arr], i = a.length, j;
    while (i > 0) {
        j = Math.floor(Math.random() * i--);
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}


// === FIXED: Derangement (no one gets themselves) ===
function createDerangement(names) {
    let result;
    do {
        result = shuffle(names);
    } while (result.some((name, i) => name === names[i]));
    return result;
}


// === MAIN FUNCTION: Generate Secret Santa ===
function generateLinks() {
    const namesText = document.getElementById("names").value.trim();
    if (!namesText) return alert("Please enter at least two names.");

    const names = namesText.split("\n").map(n => n.trim()).filter(Boolean);
    if (names.length < 2) return alert("You need at least 2 participants.");

    // Deranged shuffle ensures no one gets themselves
    const recipients = createDerangement(names);

    const assignments = {};

    // Encrypt each assignment with their own name as the key
    names.forEach((name, i) => {
        assignments[name] = encrypt(recipients[i], name);
    });

    // Display generated links
    const linksDiv = document.getElementById("links");
    linksDiv.innerHTML = "<h3>Share These Links:</h3>";

    names.forEach(name => {
        const link = `${window.location.origin}${window.location.pathname}#${encodeURIComponent(name)}`;
        linksDiv.innerHTML += `<p><a href="${link}" target="_blank">${name}'s link</a></p>`;
    });

    // Download assignments.json
    const blob = new Blob([JSON.stringify(assignments)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    linksDiv.innerHTML += `<br><a href="${url}" download="assignments.json">
        <button>Download assignments.json</button></a>`;
}


// === ON PAGE LOAD: If URL has #name, reveal their result ===
window.addEventListener("load", () => {
    const name = decodeURIComponent(location.hash.substring(1));
    if (!name) return;

    fetch(repoPath)
        .then(r => r.json())
        .then(data => {
            const encrypted = data[name];
            if (!encrypted) {
                alert("No assignment found for this name.");
                return;
            }

            const result = decrypt(encrypted, name);
            if (!result) {
                alert("Decryption failed.");
                return;
            }

            // Reveal UI
            document.getElementById("setup").classList.add("hidden");
            document.getElementById("reveal").classList.remove("hidden");
            document.getElementById("assignment").textContent = result;
        })
        .catch(() => {
            alert("Could not load assignments.json");
        });
});
</script>

</body>
</html>