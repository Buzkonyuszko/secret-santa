<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secret Santa</title>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
  input, button { padding: 0.5rem; margin: 0.5rem 0; width: 100%; }
</style>
</head>
<body>

<h1>Secret Santa ðŸŽ…</h1>

<div id="setup">
  <h2>Step 1: Enter Names</h2>
  <textarea id="names" rows="6" placeholder="Enter names, one per line"></textarea>
  <button onclick="generateLinks()">Generate Links</button>
  <div id="links"></div>
</div>

<div id="reveal" style="display:none;">
  <h2>Your Secret Santa Assignment</h2>
  <p id="assignment"></p>
</div>

<script>
const repoPath = "https://Buzkonyuszko.github.io/secret-santa/assignments.json";

// Encrypt/Decrypt using AES
function encrypt(text, password) {
    return CryptoJS.AES.encrypt(text, password).toString();
}

function decrypt(ciphertext, password) {
    try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, password);
        return bytes.toString(CryptoJS.enc.Utf8);
    } catch {
        return null;
    }
}

// Shuffle function
function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// Generate secret links
function generateLinks() {
    const namesText = document.getElementById("names").value.trim();
    if (!namesText) return alert("Please enter at least two names.");
    
    const names = namesText.split("\n").map(n => n.trim()).filter(Boolean);
    if (names.length < 2) return alert("You need at least two participants.");

    let shuffled;
    // ðŸ”¥ Ensure no one gets themselves
    do {
        shuffled = shuffle([...names]);
    } while (shuffled.some((name, i) => name === names[i]));

    const assignments = {};

    names.forEach((name, i) => {
        const recipient = shuffled[i];
        assignments[name] = encrypt(recipient, name);
    });

    const linksDiv = document.getElementById("links");
    linksDiv.innerHTML = "<h3>Share these links with participants:</h3>";
    names.forEach(name => {
        const link = `${window.location.origin}${window.location.pathname}#${encodeURIComponent(name)}`;
        linksDiv.innerHTML += `<p><a href="${link}" target="_blank">${name}'s link</a></p>`;
    });

    // Offer download of assignments.json
    const blob = new Blob([JSON.stringify(assignments)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    linksDiv.innerHTML += `<a href="${url}" download="assignments.json">Download assignments.json</a>`;
}

// On page load â€” check for hash to reveal assignment
window.addEventListener("load", () => {
    const hash = decodeURIComponent(window.location.hash.substring(1));
    if (!hash) return;
    
    fetch(repoPath)
        .then(res => res.json())
        .then(data => {
            const decrypted = decrypt(data[hash], hash);
            if (decrypted) {
                document.getElementById("setup").style.display = "none";
                document.getElementById("reveal").style.display = "block";
                document.getElementById("assignment").textContent = decrypted;
            } else {
                alert("No assignment found or decryption failed.");
            }
        })
        .catch(() => alert("Could not load assignments.json"));
});
</script>

</body>
</html>